---
layout: default_ds_blog
title: "August 2019: Returns Based Style Analysis in R"
description: ""
Comment: "Returns Based Style Analysis in R"
date: 2019-08-25
---

<div id="wrapper">
	<div id="blog-page" class="blogcontainer">
<h3>Introduction</h3> <br>
Returns Based Style Analysis (RBSA) is a well known technique in portfolio optimisation that seeks to decompose an investment strategy (for example a 
<a href = "https://en.wikipedia.org/wiki/Mutual_fund">mutual fund </a>) into 
underlying 'styles' such as Large Cap Growth, Small Cap Value etc. <br> <br>
Developed by Sharpe \([1]\), \([2]\), this technique represents the return series of an investment strategy over \(T\) time periods,
\(\{R_t, \, t = 1, \ldots, T\}\), as a linear combination of \(n\) style factors \(F_i\), for example, passive market indices, with individual weightings, \(w_i\):

\begin{align} R_t &= w_{1} F_{1t} + w_{2} F_{2t} + \cdots + w_{n} F_{nt} + \varepsilon_t, \qquad \qquad t = 1, \ldots, T \label{eq:1} \tag{I1} \\ \\
 &= \mathbf{F_t} \cdot \mathbf{w} + \varepsilon_t  \label{eq:2} \tag{I2}
\end{align} 
 
where \(F_{it}\) is the return on the \(i^{th} \) style factor at time \(t\) in \(\eqref{eq:1}\) <br> <br>
and \(\mathbf{F_t}\), \(\mathbf{w}\) written in matrix notation in \(\eqref{eq:2}\) are below,
\begin{equation} 
	\mathbf{F_t} = 
	\begin{bmatrix}
		F_{1t}, \, F_{2t}, \, \cdots, \, F_{nt}
	\end{bmatrix} 
	\qquad
	\qquad
	\mathbf{w}=
	\begin{bmatrix}
		w_{1}, \, w_{2}, \, \cdots, \, w_{n}
	\end{bmatrix}^T
\end{equation}

<!-- To reference the equation with the \tag above
\(\eqref{eq:1}\)-->
(The RBSA model is therefore a special case of the more general linear factor model, \(R_t= \mathbf{F_t} \cdot \mathbf{w_t} + \varepsilon_t \),
 where the factor weights, \(w_{it}\), are time-invariant)

<br><br>

A benefit of this approach is that unlike fundamental analysis, which relies on the (often not readily available) actual holdings of the strategy to determine the style/asset class weighting, RBSA only 
requires the return series of the investment strategy and market indices which is relatively easily available for publically traded investments via common data vendors like Bloomberg and Morningstar. 

<br><br>

Sharpe proposes choosing the weights \(w_i \) that minimises the <i>variance</i> of the non-factor returns \(\varepsilon_i\). In other words not seeking to minimise the 
<u>distance</u> between
the strategy return stream \(R_{t}\) and the regression model \(\eqref{eq:1}\) but rather to minimise the <u>variance of the distance</u> so that the two time series look as close as possible
to two equidistant lines. See picture below:

<br><br>
The (as close as possible) constant difference between the two return streams is interpreted by Sharpe as representing the manager's constant skill/contribution to the portfolio. This contribution can of 
course be negative.

<br><br>
The problem statement is therefore: <b> Minimise the variance of \(\varepsilon_t \) by only varying the factor weights \(w_i \) </b> <br><br>

Mathematically:
\begin{align}
\min_{\mathbf{w} \in \mathbb{R}^n} \mbox{var}(\varepsilon_t) &= \mbox{var} (R_t - \mathbf{F_t} \cdot \mathbf{w}) \label{eq:3.0} \tag{I3}\\ \\
\mbox{subject to:} \quad \sum_{i=1}^{n} w_1 &= 1 \label{eq:4} \tag{I4} \\
0 \le w_i &\le 1, \quad \forall i \label{eq:5} \tag{I5}
\end{align}

Where the constraint \(\eqref{eq:5}\) describes the requirement of constructing a long only portfolio \(\mathbf{F_t}\) (i.e. weights cannot be negative) and 
without leverage (i.e. weights cannot be greater than \(1\)) <br> <br>

Expanding \(\eqref{eq:3.0}\) and noting that, for a random variable \(X\), \(\mbox{var}(X) = \mathbb{E}[X^2] - (\mathbb{E}[X])^2 \):

\begin{align}
\mbox{var} (R_t - \mathbf{F_t} \cdot \mathbf{w}) &= \frac{1}{T} \sum_{t=1}^T(R_t - \mathbf{F_t} \cdot \mathbf{w})^2 - (\frac{\sum_{t=1}^T(R_t - \mathbf{F_t} \cdot \mathbf{w})}{T}) \\
&= \underbrace{44-x}_{D} -\underbrace{34-3e}_{d} -\underbrace{234^34}_{24} \\ 
\end{align}

rearranging and simplifying (final line reference) here and noting that the term \( c\) above is a constant we have the problem stated as:
\begin{align}
\min_{\mathbf{w} \in \mathbb{R}^n} \mbox{var}(\varepsilon_t) &= \frac{1}{2} \mathbf{w}^T \! \cdot \! \mathbf{D} \! \cdot \! \mathbf{w} -\mathbf{d}^T \! \cdot \! \mathbf{w}
\label{eq:6} \tag{I6}
\end{align}
subject to constraints \(\eqref{eq:4}\) and \(\eqref{eq:5}\) <br><br>
where \( \mathbf{D} = ... \) and \(\mathbf{d} = ... \) <br><br>
<hr><br>

<h3>Implementing in R:</h3> <br>
Link to my GitHub repo: <a href = "https://github.com/ThomasHandscomb/Returns-Based-Style-Analysis"> Returns-Based-Style-Analysis </a>
<br><br>
So how do we go about using R to solve the optimisation problem represented in equation \(\eqref{eq:6}\)? As luck would have 
it R has a quadratic programming (QP) solver in the <i> quadprog </i>  package to solve precisely this QP problem
 <br><br>
Quoting directly from the description in the cran quadprog package <a href = "https://cran.r-project.org/web/packages/quadprog/quadprog.pdf"> documentation:</a> <br>
"This routine implements the dual method of Goldfarb and Idnani (1982, 1983) for solving quadratic programming problems of the form 
\begin{align} \min_{\mathbf{w} \in \mathbb{R}^n} \frac{1}{2} \mathbf{w}^T \! \cdot \! \mathbf{D} \! \cdot \! \mathbf{w} -\mathbf{d}^T \! \cdot \! \mathbf{w} \\ \\
\mbox{with the constraints:} \quad A^T\mathbf{w} >= \mathbf{w}_0 \label{eq:7} \tag{I7}
\end{align}

This is implemented in R by calling the QP-solver: 
\begin{equation} \mbox{solve.QP(Dmat}= \mathbf{D} \mbox{, dvec}= \mathbf{d} \mbox{, Amat}= A, w_0\mbox{vec}= \mathbf{w}_0, m_{eq}=1) \end{equation} 
where \( m_{eq} \) specifies the first number of constraints in \(\eqref{eq:7}\) to be treated as equalities, with the remainder as inequalities."
<br><br>
The below steps through an example of how to construct the optimisation matrices in \(\eqref{eq:7}\) for a RBSA, given only the return streams of an investment strategy and style factors, 
and how this is implemented using quadprog. <br> This example uses a simulated return stream over \(T = 10 \) time periods with a choice of \(4\) underlying indicies

	<pre>
	<code class="r">
	#----------------
	### A Toy Example_TH
	#----------------

	install.packages("quadprog")

	library (quadprog)
	library (Matrix)

	# Fund returns matrix over T = 4 time periods
	T = 4

	e = matrix(1,T,1)
	e
	</code>
	</pre>

Define a very simple return stream here

	<pre> 
	<code class="r">
	# Specify the fund returns
	R <- matrix(c(1.5, 1.6, 1.75, 1.70))
	R

	# n = 4 Index returns over T = 4 time periods
	F1 <- c(0.76, 0.81, 0.89, 0.80)
	F2 <- c(0.93, 0.45, 0.76, 0.45)
	F3 <- c(0.15, 0.17, 0.21, 0.78)
	F4 <- c(0.20, 0.25, 0.58, 0.81)

	n = 4

	F <- cbind(F1, F2, F3, F4)
	F
	t(F)
	</code>
	</pre>

The matrix algebra occurs here

	<pre> 
	<code class="r">
	# Set up the symmetric, positive definite matrix D
	M <- diag(T) - ((e %*% t(e))/T)
	#M <- diag(T)
	class(M)
	M
	</code>
	</pre>	

Let's check we can't find a better solution at random, i.e. a random choice of \( \mathbf{w} \) that achieves a lower \( \mbox{var} (R_t - \mathbf{F_t} \cdot \mathbf{w}) \) 
<br><hr><br>

<h3>References:</h3> <br>
<ul>
	<li> \([1]\) W. F. Sharpe. Determining a fund’s eﬀective asset mix. <i> Investment Management Review, </i> pages 59–69, December 1988. </li>
	<li> \([2]\) W. F. Sharpe. Asset allocation: Management style and performance measurement. <i> Journal of Portfolio Management, </i> pages 7–19, Winter 1992. </li>
</ul>

</div>